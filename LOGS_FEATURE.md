# 日志功能更新说明

## 🎯 功能概述

实现了实时日志窗口的开关控制功能，用户可以灵活控制是否接收实时日志输出。

## 🔧 主要改进

### 1. 实时输出开关
- 新增实时输出开关按钮，可以控制是否接收新的日志
- 关闭实时输出时，WebSocket仍保持连接，但不处理新的日志消息
- 开启实时输出时，恢复正常的日志接收和显示

### 2. API与WebSocket协同
- 利用后端提供的REST API进行控制操作
- WebSocket负责实时数据传输和状态同步
- API调用后，WebSocket会收到相应的确认消息

### 3. 新增功能按钮
- **实时输出开关**: 控制是否接收实时日志
- **跟随模式**: 控制是否自动滚动到底部（需要实时输出开启）
- **刷新日志**: 重新加载最新的日志内容
- **加载历史**: 向上加载更多历史日志

### 4. 状态同步
- 前端状态与后端状态实时同步
- 通过WebSocket消息确认API操作结果
- 状态栏显示当前的连接状态和实时输出状态

## 🔌 API接口集成

### 支持的API接口
1. `GET /api/v1/namespaces/{namespace}/agents/{agentname}/logs/status` - 获取日志状态
2. `POST /api/v1/namespaces/{namespace}/agents/{agentname}/logs/follow` - 切换跟踪模式
3. `POST /api/v1/namespaces/{namespace}/agents/{agentname}/logs/refresh` - 刷新日志
4. `POST /api/v1/namespaces/{namespace}/agents/{agentname}/logs/history` - 加载历史日志

### WebSocket消息类型
- `follow_toggled` - 跟踪模式切换确认
- `refreshed` - 刷新操作确认
- `session_closed` - 会话关闭通知
- `history` - 历史日志数据
- `initial` - 初始日志数据
- `append` - 新增日志数据

## 🎨 用户界面改进

### 按钮布局
```
[实时输出] [跟随日志] [加载历史] [刷新日志] [清空] [全选] [复制] [关闭]
```

### 状态指示
- 连接状态标签：已连接/连接中/未连接
- 实时输出状态标签：实时输出/暂停输出
- 日志计数显示
- 快捷键提示

### 视觉反馈
- 按钮状态根据功能启用/禁用状态变化
- 实时输出关闭时，跟随按钮自动禁用
- 加载状态的loading指示器

## 🧪 测试页面

访问 `/test/logs` 页面可以测试新功能：
- 测试各个API接口
- 验证WebSocket消息处理
- 检查状态同步是否正常

## 📝 使用说明

1. **开启/关闭实时输出**
   - 点击"实时输出"按钮切换状态
   - 关闭后不再接收新日志，但可以查看历史日志
   - 开启后恢复实时日志接收

2. **跟随模式**
   - 需要先开启实时输出
   - 开启后自动滚动到最新日志
   - 手动滚动会自动关闭跟随模式

3. **刷新日志**
   - 重新加载最新的日志内容
   - 清空当前显示，重新获取数据

4. **加载历史**
   - 向上滚动或点击按钮加载更多历史日志
   - 支持分页加载，避免一次性加载过多数据

## 🔍 技术实现

### 前端架构
- Vue 3 + Composition API
- TypeScript类型安全
- Naive UI组件库
- WebSocket + REST API混合架构

### 状态管理
- 本地响应式状态管理
- WebSocket消息驱动的状态更新
- API调用与WebSocket状态同步

### 错误处理
- 完善的错误捕获和用户提示
- 网络异常的优雅降级
- 连接断开的自动重连机制

## 🚀 后续优化

1. **性能优化**
   - 虚拟滚动支持大量日志
   - 日志内容的智能缓存
   - 内存使用优化

2. **功能增强**
   - 日志搜索和过滤
   - 日志导出功能
   - 多窗口日志对比

3. **用户体验**
   - 快捷键支持
   - 主题切换
   - 字体大小调节
